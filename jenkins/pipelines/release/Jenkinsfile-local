pipeline  {
    agent any

    environment {
        MAVEN_DOCKER_IMAGE = 'maven:3.6-jdk-8'
    }

    stages  {
        stage('Print params') {
            steps {
                echo "DEVELOPMENT_VERSION ${params.DEVELOPMENT_VERSION}"
                echo "RELEASE_VERSION ${params.RELEASE_VERSION}"
                echo "DRY_RUN ${params.DRY_RUN}"
                echo "CONFIG_FILE_ID ${params.CONFIG_FILE_ID}"
                echo "GIT_USER_NAME ${params.GIT_USER_NAME}"
                echo "GIT_USER_EMAIL ${params.GIT_USER_EMAIL}"
            }
      }

        stage('Preparation')  {
            steps {
                sh "git config user.name ${params.GIT_USER_NAME}"
                sh "git config user.email ${params.GIT_USER_EMAIL}"
            }
        }

        stage('Build') {
            agent {
                docker {
                    image "${MAVEN_DOCKER_IMAGE}"
                    reuseNode true
                }
            }
            steps {
                configFileProvider([configFile(fileId: "${params.CONFIG_FILE_ID}", variable: 'MAVEN_SETTINGS')]) {
                    sh 'mvn --global-settings ${MAVEN_SETTINGS} clean install'
                }
            }   
        }

        stage('Results')  {
            steps {
                junit '**/target/surefire-reports/TEST-*.xml'
                archiveArtifacts '**/target/*.jar'
            }
        }

        stage('Release')  {
            agent {
                docker {
                    image "${MAVEN_DOCKER_IMAGE}"
                    reuseNode true
                }
            }      
            steps {
                configFileProvider([configFile(fileId: "${params.CONFIG_FILE_ID}", variable: 'MAVEN_SETTINGS')]) {
                    sh "mvn -B --global-settings ${MAVEN_SETTINGS} -DdevelopmentVersion=${params.DEVELOPMENT_VERSION} -DreleaseVersion=${params.RELEASE_VERSION} -Dresume=false -DskipTests -Darguments=-DskipTests -Pskltp -DdryRun=${params.DRY_RUN} release:prepare -DpushChanges=true release:perform -Darguments=-Dmaven.deploy.skip=true"
                }
            }
        }
    }

    post  {
        always  {
            cleanWs()
        }
    }
}
